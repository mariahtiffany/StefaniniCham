<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller=function() {
  var c = this;
	c.question = '';
	c.disableButton = false;
	c.textButton = 'Ask';
	
	c.askQuestion = function() {
		c.disableButton = true;
		c.textButton = 'Loading...';
		
		c.server.get({
			question: c.question,
			action: 'ask_question',
		}).then(function (response) {
			c.disableButton = false;
			c.textButton = 'Ask';

			c.answer = response.data.answer;
		});
	};
};]]></client_script>
        <controller_as>c</controller_as>
        <css>.panel-body, .ask-container-form-group {
		display: flex;
  	flex-direction: column;
}

.panel-body input[type=submit] {
	margin-top: 1rem;
  width: 100%;
}

.present-answer {
	margin-top: 1rem;
}</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id/>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) { }]]></link>
        <name>GPT Indexer</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
  var chUtil = new ChameleonUtil();
	var keys = chUtil.getAllConfigKeys('GPTIndexer');
	var validFields = ['GPTIndexerUrl', 'GPTIndexerKey', 'GPTIndexerHash'];
	var validateKeys = chUtil.validateKeys(keys, validFields);
	
	if (validateKeys.hasEmptyFields) {
		data.answer = validateKeys.message;
		return;
	}
	
	if (!input || input.action != 'ask_question')
		return;
	
	var question = input.question.replace(/"/g, '');

	if (!question) 
		return;

	var restMessage = new sn_ws.RESTMessageV2();
	restMessage.setEndpoint(keys.GPTIndexerUrl + "/api/v2/index/"+ keys.GPTIndexerHash +"/query");
	restMessage.setRequestHeader("ApiKey", keys.GPTIndexerKey);
	restMessage.setHttpMethod("post");
	restMessage.setRequestHeader("Content-Type", "application/json");
	restMessage.setRequestBody(JSON.stringify(question));

	try {
		var response = restMessage.execute();
		var responseBody = response.getBody();
		var httpStatus = response.getStatusCode();

		if (httpStatus != 200) {
			data.answer = 'Error: The GPT Indexer did not answer with a good status, probably you hit the rate limit, wait a couple seconds and try again!';
			return;
		}

		data.answer = JSON.parse(responseBody).response;
	} catch (e) {
		gs.error('Error calling GPT Templates: ' + e);
		data.answer = 'Error calling GPT Templates: ' + e.message;
	}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>andre.nunes@stefanini.com</sys_created_by>
        <sys_created_on>2023-05-22 17:58:46</sys_created_on>
        <sys_id>8b2c61501bc32510cc28c955624bcbd2</sys_id>
        <sys_mod_count>87</sys_mod_count>
        <sys_name>GPT Indexer</sys_name>
        <sys_package display_value="Chameleon" source="x_stefa_chameleon">15b425181b832510cc28c955624bcbd6</sys_package>
        <sys_policy/>
        <sys_scope display_value="Chameleon">15b425181b832510cc28c955624bcbd6</sys_scope>
        <sys_update_name>sp_widget_8b2c61501bc32510cc28c955624bcbd2</sys_update_name>
        <sys_updated_by>andre.nunes@stefanini.com</sys_updated_by>
        <sys_updated_on>2023-05-31 14:21:57</sys_updated_on>
        <template><![CDATA[<div class="panel panel-default">
  <div class="panel-heading">
    <h2 class="panel-title">
    		GPT Indexer
    </h2>
  </div>
  <div ng-if="!data.no_api_key" class="panel-body">
    <form ng-submit="c.askQuestion()">
      <div class="ask-container-form-group">
        <label>Ask your question to GPT Indexer</label>
        <input name="question" ng-model="c.question">
        <small>The answers are provided by GPT Indexer</small>
      </div>
      <input type="submit" ng-value="c.textButton" ng-disabled="c.disableButton" class="btn btn-primary" />
		</form>
    
    <div ng-show="c.answer" class="present-answer">
      <p>
        Our GPT Indexer says: <br/>{{c.answer}}
      </p>
    </div>
  </div>
  <div ng-if="data.no_api_key" class="panel-body">
    <p>
      You need to configure the options of this Widget first!
    </p>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
